#!/bin/bash

######################################
#                                    #
#   Author  : Youri Klaassens        #
#   Alias   : Xhendos                #
#   Date    : 26th of August, 2017   #
#                                    #
######################################

# Reads a list of IP adresses and tries if it is vulnerable for the CVE-2017-5638 Exploit.
# Once there is a server vulnerable the following details will be printed {IP Adres, Port}
# Because a webserver can run on either port 80 or port 443, this needs to be specified by the user.
# Usage: ./main.sh [Text file containing IP adresses] [Port]

# CHANGELOG
# 26 August, 2017 - Added TIME_ELAPSED and SCANNED_ADDRESSES. Format to print a match is changed.

typeset -i START_TIME=$(date +%s)
typeset -i SCANNED_ADDRESSES=0

FILE_NAME=$1
PORT=$2

while read IP
do
        ((SCANNED_ADDRESSES=SCANNED_ADDRESSES+1))
        echo "Going to try $IP with port $PORT"
        OUTPUT=$(./struts_check.sh $IP $PORT)

        if [ "$OUTPUT" == "True" ];
        then
                echo "[APACHE_STRUTS] Match: {$IP:$PORT}"
        fi


done < $FILE_NAME

typeset -i END_TIME=$(date +%s)
typeset -i TIME_ELAPSED=$(($END_TIME - $START_TIME))
HOURS=$(($TIME_ELAPSED / 3600))
MINUTES=$((($TIME_ELAPSED % 3600) / 60))
SECONDS=$((($TIME_ELAPSED % 3600) % 60))

echo "[APACHE_STRUTS] Execution time took "$HOURS" hours, "$MINUTES" minutes and "$SECONDS" seconds."
echo "[APACHE_STRUTS] Scanned "$SCANNED_ADDRESSES" addresses."
